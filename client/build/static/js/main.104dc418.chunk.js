(this.webpackJsonpclient=this.webpackJsonpclient||[]).push([[0],{137:function(e,t,a){},140:function(e,t,a){},222:function(e,t,a){"use strict";a.r(t);var n,c=a(1),i=a.n(c),r=a(7),s=a.n(r),l=(a(137),a(138),a(139),a(140),a(118)),o=a(8),u=a(55),d=a(57),j=a(16),f=a.n(j),m=a(9),b=a(29),h=a(130),p=a(132),O=(a(141),a(3)),x=c.forwardRef((function(e,t){e.control;var n=e.displayMode,i=(e.error,e.help,e.maxLength),r=e.name,s=e.onChange,l=e.required,o=e.showHeader,u=void 0!==o&&o,d=e.type,j=void 0===d?"datetime":d,f=e.value,b=e.id,h=void 0===b?r:b,x=e.bulmaCalendarOptions,v=Object(p.a)(e,["control","displayMode","error","help","maxLength","name","onChange","required","showHeader","type","value","id","bulmaCalendarOptions"]),y=c.useRef(),g=c.useRef();return c.useImperativeHandle(t,(function(){return y.current})),c.useEffect((function(){var e=a(143);g.current=new e(y.current,Object(m.a)({showHeader:u,type:j,displayMode:n,validateLabel:"\u786e\u5b9a",cancelLabel:"\u53d6\u6d88",clearLabel:"\u6e05\u9664",todayLabel:"\u4eca\u5929",nowLabel:"\u73b0\u5728",minuteSteps:1},x))}),[n,u,j]),c.useEffect((function(){var e=g.current;return e.on("select",(function(){s({target:y.current},"time"===j?e.startTime:e.startDate)})),function(){g.current.removeListeners("select")}}),[s]),Object(O.jsx)("input",Object(m.a)(Object(m.a)({},v),{},{ref:y,defaultValue:f,id:h,maxLength:i,name:r,required:l}))})),v=a(78),y=a(94),g=a(129),N=Object(v.createTRPCClient)({url:"/api/trpc",transformer:g.a}),w=Object(v.createReactQueryHooks)({client:N,queryClient:new y.a});!function(e){e.once="once",e.repeat="repeat"}(n||(n={}));var k=6e4,C=36e5,M=("undefined"===typeof window?new URL("https://localhost"):new URL(location.href)).searchParams.get("id")||"",L=a(128),Q=a(22),D=a.n(Q);function S(){var e,t=Object(o.f)();window.h=t;var a=new URLSearchParams(t.location.search.slice(1)).get("id");console.log("locId",a,t.location.search);var i=w.useQuery(["alarms.all"],{staleTime:3e3}),r=Object(c.useState)(a&&(null===(e=i.data)||void 0===e?void 0:e.find((function(e){return e.id===a})))||{type:"repeat",ahead:0,title:"",notify:!0,alert:!1,duration:0,disabled:!1}),s=Object(h.a)(r,2),l=s[0],u=s[1],j=w.useMutation("alarms.edit",{onMutate:function(e){return Object(b.a)(f.a.mark((function t(){return f.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,w.cancelQuery(["alarms.all"]);case 2:w.setQueryData(["alarms.all"],i.data.map((function(t){return t.id===e.id?Object(m.a)(Object(m.a)({},t),e):t})));case 3:case"end":return t.stop()}}),t)})))()},onSettled:function(){w.invalidateQuery(["alarms.all"])}}),p=w.useMutation("alarms.add",{onMutate:function(e){return Object(b.a)(f.a.mark((function e(){return f.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,w.cancelQuery(["alarms.all"]);case 2:case"end":return e.stop()}}),e)})))()},onSettled:function(){w.invalidateQuery(["alarms.all"])}});function v(e,t){u(Object(m.a)(Object(m.a)({},l),{},Object(d.a)({},e,t)))}return Object(O.jsxs)("div",{className:"form",children:[Object(O.jsxs)("div",{className:"field is-grouped",children:[Object(O.jsx)("label",{className:"label",children:"\u6807\u9898:"}),Object(O.jsx)("div",{className:"control",children:Object(O.jsx)("input",{className:"input",type:"text",placeholder:l.title,onChange:function(e){return v("title",e.target.value)}})})]}),Object(O.jsxs)("div",{className:"field is-grouped",children:[Object(O.jsx)("label",{className:"label",children:"\u7c7b\u578b:"}),Object(O.jsx)("div",{className:"control",children:Object(O.jsx)("div",{className:"select",children:Object(O.jsxs)("select",{defaultValue:l.type,onChange:function(e){v("type",e.target.value)},children:[Object(O.jsx)("option",{value:n.repeat,children:"\u5faa\u73af"}),Object(O.jsx)("option",{value:n.once,children:"\u5b9a\u65f6"})]})})})]}),l.type===n.once&&Object(O.jsxs)("div",{className:"field is-grouped",children:[Object(O.jsx)("label",{className:"label",children:"\u5b9a\u65f6:"}),Object(O.jsx)("div",{className:"control",children:Object(O.jsx)(x,{className:"input",type:"time",value:new Date(l.duration+16*C),onChange:function(e,t){var a=new Date(0);a.setHours(t.getHours()+a.getHours()),a.setMinutes(t.getMinutes()+a.getMinutes()),v("timeout",Date.now()+a.getTime())}})})]}),l.type===n.repeat&&Object(O.jsxs)("div",{className:"field is-grouped",children:[Object(O.jsx)("label",{className:"label",children:"\u5faa\u73af:"}),Object(O.jsx)("div",{className:"control",children:Object(O.jsx)(L.a,{showSecond:!1,defaultValue:D()(l.duration+16*C),className:"xxx",onChange:function(e){v("duration",e.hours()*C+e.minutes()*k)}})})]}),Object(O.jsxs)("div",{className:"field is-grouped",children:[Object(O.jsx)("label",{className:"label",children:"\u63d0\u524d:"}),Object(O.jsx)("div",{className:"control",children:Object(O.jsx)("input",{type:"number",min:0,max:1440,defaultValue:l.ahead,onChange:function(e){v("ahead",Number(e.target.value)||0)}})})]}),Object(O.jsxs)("div",{className:"field is-grouped",children:[Object(O.jsx)("label",{className:"label",children:"\u901a\u77e5:"}),Object(O.jsx)("div",{className:"control",children:Object(O.jsx)("input",{type:"checkbox",defaultChecked:l.notify,onChange:function(e){v("notify",e.target.checked)}})})]}),Object(O.jsxs)("div",{className:"field is-grouped",children:[Object(O.jsx)("label",{className:"label",children:"\u5f39\u7a97:"}),Object(O.jsx)("div",{className:"control",children:Object(O.jsx)("input",{type:"checkbox",defaultChecked:l.alert,onChange:function(e){v("alert",e.target.checked)}})})]}),Object(O.jsxs)("div",{className:"field is-grouped",children:[Object(O.jsx)("div",{className:"control",children:Object(O.jsx)("button",{onClick:function(e){!function(e){"id"in e&&e.id?j.mutate(e):(e.uid=M,p.mutate(e))}(l),console.log("history",t),t.goBack()},className:"button is-primary is-link",children:"\u4fdd\u5b58"})}),Object(O.jsx)("div",{className:"control",children:Object(O.jsx)("button",{onClick:function(e){t.push("/")},className:"button is-link is-light",children:"\u53d6\u6d88"})})]})]})}var T=a(82),H=a.n(T),R=a(125),q=a(131),I=a(83),E=a(126),P=a(127),U=function(){function e(t,a){Object(E.a)(this,e),this.alarms=t,this.save=a,this.timers=new Map,this.updateTimers(),window.alarmManager=this}return Object(P.a)(e,[{key:"notify",value:function(e){var t="".concat(e.title," | \u6574\u70b9\u62a5\u65f6");e.notify&&new Notification(t,{body:(new Date).toLocaleString(),vibrate:1,requireInteraction:!0}),e.alert&&alert(t),console.log("notify",(new Date).toLocaleString(),e)}},{key:"clearTimers",value:function(e){var t,a=this.timers.get(e.id)||[],n=Object(I.a)(a);try{for(n.s();!(t=n.n()).done;){var c=t.value;clearTimeout(c),clearInterval(c)}}catch(i){n.e(i)}finally{n.f()}this.timers.delete(e.id)}},{key:"updateTimers",value:function(){var e,t=this,a=Object(I.a)(this.alarms);try{var c=function(){var a=e.value;if(a.disabled||a.done)return t.clearTimers(a),"continue";var c=t.timers.get(a.id);if(!c){c=[],console.log("updateTimers",a);var i=Date.now();if(a.type===n.once){var r=setTimeout((function(){t.notify(a),t.save(Object(m.a)(Object(m.a)({},a),{},{done:!0}))}),a.timeout-(i+a.ahead*k));c.push(r)}else if(a.type===n.repeat){!function e(){var n=a.duration-(Date.now()+a.ahead*k)%a.duration,i=setTimeout((function(){t.notify(a),e()}),n);c[0]=i,console.log("next repeat ".concat(a.title),new Date(Date.now()+n).toLocaleString(),a)}()}t.timers.set(a.id,c)}};for(a.s();!(e=a.n()).done;)c()}catch(i){a.e(i)}finally{a.f()}}}]),e}();function V(){var e,t=Object(o.f)(),a=w.useQuery(["alarms.all",M],{staleTime:3e3}),n=w.useMutation("alarms.sortAll",{onMutate:function(e){return Object(b.a)(f.a.mark((function t(){var n,c;return f.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,w.cancelQuery(["alarms.all"]);case 2:c=new Map(null===(n=a.data)||void 0===n?void 0:n.map((function(e){return[e.id,e]}))),w.setQueryData(["alarms.all"],e.map((function(e){return c.get(e)})).filter(Boolean));case 4:case"end":return t.stop()}}),t)})))()},onSettled:function(){w.invalidateQuery(["alarms.all"])}}),i=function(){var e=Object(b.a)(f.a.mark((function e(t){return f.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.mutate(t.map((function(e){return e.id})));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),r=w.useMutation("alarms.delete",{onMutate:function(e){return Object(b.a)(f.a.mark((function t(){return f.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,w.cancelQuery(["alarms.all"]);case 2:w.setQueryData(["alarms.all"],a.data.filter((function(t){return t.id!=e})));case 3:case"end":return t.stop()}}),t)})))()},onSettled:function(){w.invalidateQuery(["alarms.all"])}}),s=w.useMutation("alarms.edit",{onMutate:function(e){return Object(b.a)(f.a.mark((function t(){return f.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,w.cancelQuery(["alarms.all"]);case 2:w.setQueryData(["alarms.all"],a.data.map((function(t){return t.id===e.id?Object(m.a)(Object(m.a)({},t),e):t})));case 3:case"end":return t.stop()}}),t)})))()},onSettled:function(){w.invalidateQuery(["alarms.all"])}});return Object(c.useEffect)((function(){a.data&&new U(a.data,(function(e){s.mutate(e)}))}),[a.data]),Object(O.jsxs)("nav",{className:"panel",children:[Object(O.jsxs)("p",{className:"panel-heading",children:[Object(O.jsx)("span",{style:{flex:1},children:"\u6574\u70b9\u62a5\u65f6"}),Object(O.jsx)("button",{className:"button is-link is-small",style:{marginRight:10},title:"\u4fdd\u5b58\u6c38\u4e45\u94fe\u63a5",onClick:function(e){var t=new URL(location.href);t.searchParams.append("id",Object(q.a)()),location.href=t.toString()},children:Object(O.jsx)("i",{className:"fas fa-external-link-alt","aria-hidden":"true"})}),Object(O.jsx)("button",{className:"button is-primary is-small",title:"\u6dfb\u52a0\u65b0\u7684\u63d0\u9192",onClick:function(e){t.push("/form")},children:Object(O.jsx)("i",{className:"fas fa-plus","aria-hidden":"true"})})]}),Object(O.jsx)(R.ReactSortable,{list:a.data||[],setList:i,children:null===(e=a.data)||void 0===e?void 0:e.map((function(e){return Object(O.jsxs)("a",{className:"panel-block",children:[Object(O.jsx)("span",{className:"panel-icon",children:Object(O.jsx)("i",{className:"fas fa-".concat("once"===e.type?"hourglass-half":"sync"),"aria-hidden":"true"})}),Object(O.jsxs)("span",{className:"ca-title",children:[e.title,Object(O.jsx)("div",{className:"ca-subtitle",children:"once"===e.type?H()(Number(e.timeout)).format("YYYY/MM/DD HH:mm"):H()(Number(e.duration)).add(-8,"h").format("HH:mm")})]}),Object(O.jsx)("i",{className:"fas fa-times remove-btn","aria-hidden":"true",onClick:function(t){confirm("\u786e\u5b9a\u8981\u5220\u9664\u300c".concat(e.title,"\u300d\u5417?"))&&r.mutate(e.id)}}),Object(O.jsx)("i",{className:"fas fa-cog config-btn","aria-hidden":"true",onClick:function(a){t.push("/form?id=".concat(e.id))}}),Object(O.jsxs)("div",{className:"field",children:[Object(O.jsx)("input",{id:e.id,type:"checkbox",className:"switch",defaultChecked:!e.disabled,onChange:function(t){s.mutate(Object(m.a)(Object(m.a)({},e),{},{disabled:!t.target.checked}))}}),Object(O.jsx)("label",{htmlFor:e.id})]})]},e.id)}))})]})}var Y=a(227);function B(){Object(o.g)();return Object(O.jsx)(Y.a,{children:Object(O.jsxs)(o.c,{children:[Object(O.jsx)(o.a,{path:"/form",children:Object(O.jsx)(S,{})}),Object(O.jsx)(o.a,{path:"/",children:Object(O.jsx)(V,{})})]})})}function J(){return Object(O.jsx)("div",{className:Object(l.a)("root","container"),children:Object(O.jsx)(u.a,{children:Object(O.jsx)(B,{})})})}var A=function(e){0};s.a.render(Object(O.jsx)(i.a.StrictMode,{children:Object(O.jsx)(J,{})}),document.getElementById("root")),A()}},[[222,1,2]]]);
//# sourceMappingURL=main.104dc418.chunk.js.map